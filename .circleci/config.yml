version: 2.1

jobs:
  build:
    docker:
      - image: adrianjimenez/symfony_good_practices:v1
        environment:
          DATABASE_URL: "mysql://root@127.0.0.1:3306/universe?serverVersion=8.0"
          MYSQL_ALLOW_EMPTY_PASSWORD: true

      - image: mysql:8.0
        environment:
          MYSQL_DATABASE: universe
          MYSQL_ALLOW_EMPTY_PASSWORD: true

    steps:
      - checkout

      - restore_cache:
          keys:
            - composer_{{ checksum "composer.lock" }}

      - run:
          name: Clear cache
          command: rm -rf var/cache/*

      - run: composer install -n

      - run: php bin/console doctrine:migrations:migrate --env=test --no-interaction

      - run: php bin/console doctrine:fixtures:load --env=test --no-interaction

      - run:
          name: Run tests
          command: make test

      - store_test_results:
          path: ./test-results

      - store_artifacts:
          path: ./test-results

      - save_cache:
          key: composer_{{ checksum "composer.lock" }}
          paths:
            - ./vendor