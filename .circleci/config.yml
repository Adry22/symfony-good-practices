version: 2.1

jobs:
  build:
    steps:
      - checkout

      - restore_cache:
          keys:
            - composer_{{ checksum "composer.lock" }}
      - run:
          name: Clear cache
          command: rm -rf var/cache/*

      - run: composer install -n

      - run: yarn install

      - run: yarn encore production

      - run: php bin/console doctrine:migrations:migrate --env=test --no-interaction

      - run: php bin/console doctrine:fixtures:load --env=test --no-interaction

      - run:
          name: Run tests
          command: make test

      - store_test_results:
          path: ./test-results

      - store_artifacts:
          path: ./test-results